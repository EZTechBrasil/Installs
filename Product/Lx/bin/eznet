#!/bin/bash

SERVICOS=("ez2serial" "ezhowsc" "ezconnect" "ezserver" "ezlx-rest-api")

add_service_suffix() {
  local svc="$1"
  [[ "$svc" != *.service ]] && svc="${svc}.service"
  echo "$svc"
}

service_exists() {
  local svc="$1"
  systemctl list-unit-files | grep -q "^$svc"
}

is_active() {
  local svc="$1"
  systemctl is-active --quiet "$svc"
}

start_all() {
  echo "Iniciando todos os servi√ßos ezlx..."
  local svc=$(add_service_suffix "ezserver")
  echo "Iniciando $svc..."
  if service_exists "$svc"; then
    if is_active "$svc"; then
      echo "üîÑ Servi√ßo $svc j√° est√° rodando."
    else
       systemctl start "$svc" 
     echo "‚úÖ Servi√ßo $svc iniciado com sucesso."
    fi
  else
    echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado. Pulando..."
  fi

  for servico in "${SERVICOS[@]}"; do
    [[ "$servico" == "ezserver" ]] && continue
    svc=$(add_service_suffix "$servico")
    echo "Iniciando $svc..."
    if service_exists "$svc"; then
      if is_active "$svc"; then
        echo "üîÑ Servi√ßo $svc j√° est√° rodando."
      else
        systemctl start "$svc"
        echo "‚úÖ Servi√ßo $svc iniciado com sucesso."
      fi
    else
      echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado. Pulando..."
    fi
  done
  echo "‚úÖ Todos os servi√ßos foram iniciados."
}

stop_all() {
  echo "Parando todos os servi√ßos ezlx..."
  for servico in "${SERVICOS[@]}"; do
    [[ "$servico" == "ezserver" ]] && continue
    svc=$(add_service_suffix "$servico")
    echo "Parando $svc..."
    if service_exists "$svc"; then
      if is_active "$svc"; then
        systemctl stop "$svc"
        echo "‚úÖ Servi√ßo $svc parado com sucesso."
      else
        echo "‚è∏Ô∏è Servi√ßo $svc j√° est√° parado."
      fi
    else
      echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado. Pulando..."
    fi
  done

  svc=$(add_service_suffix "ezserver")
  echo "Parando $svc..."
  if service_exists "$svc"; then
    if is_active "$svc"; then
      systemctl stop "$svc"
      echo "‚úÖ Servi√ßo $svc parado com sucesso."
    else
      echo "‚è∏Ô∏è Servi√ßo $svc j√° est√° parado."
    fi
  else
    echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado. Pulando..."
  fi
  echo "‚úÖ Todos os servi√ßos foram parados."
}

restart_all() {
  echo "Reiniciando todos os servi√ßos ezlx..."
  for servico in "${SERVICOS[@]}"; do
    [[ "$servico" == "ezserver" ]] && continue
    svc=$(add_service_suffix "$servico")
    echo "Reiniciando $svc..."
    if service_exists "$svc"; then
      systemctl restart "$svc"
      echo "‚úÖ Servi√ßo $svc reiniciado com sucesso."
    else
      echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado. Pulando..."
    fi
  done

  svc=$(add_service_suffix "ezserver")
  echo "Reiniciando $svc..."
  if service_exists "$svc"; then
    systemctl restart "$svc"
    echo "‚úÖ Servi√ßo $svc reiniciado com sucesso."
  else
    echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado. Pulando..."
  fi
  echo "‚úÖ Todos os servi√ßos foram reiniciados."
}

start_service() {
  echo "Servi√ßos dispon√≠veis para iniciar:"
  select servico in "${SERVICOS[@]}" "Cancelar"; do
    if [[ "$servico" == "Cancelar" ]]; then
      echo "Opera√ß√£o cancelada."
      break
    elif [[ -n "$servico" ]]; then
      svc=$(add_service_suffix "$servico")
      echo "Iniciando $svc..."
      if service_exists "$svc"; then
        if is_active "$svc"; then
          echo "üîÑ Servi√ßo $svc j√° est√° rodando."
        else
          systemctl start "$svc"
          echo "‚úÖ Servi√ßo $svc iniciado com sucesso."
        fi
      else
        echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado."
      fi
      break
    else
      echo "Op√ß√£o inv√°lida. Tente novamente."
    fi
  done
}

stop_service() {
  echo "Servi√ßos dispon√≠veis para parar:"
  select servico in "${SERVICOS[@]}" "Cancelar"; do
    if [[ "$servico" == "Cancelar" ]]; then
      echo "Opera√ß√£o cancelada."
      break
    elif [[ -n "$servico" ]]; then
      svc=$(add_service_suffix "$servico")
      echo "Parando $svc..."
      if service_exists "$svc"; then
        if is_active "$svc"; then
          systemctl stop "$svc"
          echo "‚úÖ Servi√ßo $svc parado com sucesso."
        else
          echo "‚è∏Ô∏è Servi√ßo $svc j√° est√° parado."
        fi
      else
        echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado."
      fi
      break
    else
      echo "Op√ß√£o inv√°lida. Tente novamente."
    fi
  done
}

restart_service() {
  echo "Servi√ßos dispon√≠veis para reiniciar:"
  select servico in "${SERVICOS[@]}" "Cancelar"; do
    if [[ "$servico" == "Cancelar" ]]; then
      echo "Opera√ß√£o cancelada."
      break
    elif [[ -n "$servico" ]]; then
      svc=$(add_service_suffix "$servico")
      echo "Reiniciando $svc..."
      if service_exists "$svc"; then
        systemctl restart "$svc"
        echo "‚úÖ Servi√ßo $svc reiniciado com sucesso."
      else
        echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado."
      fi
      break
    else
      echo "Op√ß√£o inv√°lida. Tente novamente."
    fi
  done
}

status_service() {
  echo "Servi√ßos dispon√≠veis para ver status:"
  select servico in "${SERVICOS[@]}" "Cancelar"; do
    if [[ "$servico" == "Cancelar" ]]; then
      echo "Opera√ß√£o cancelada."
      break
    elif [[ -n "$servico" ]]; then
      svc=$(add_service_suffix "$servico")
      if service_exists "$svc"; then
        systemctl status "$svc"
      else
        echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado."
      fi
      break
    else
      echo "Op√ß√£o inv√°lida. Tente novamente."
    fi
  done
}

# Argumentos de linha de comando
if [[ "$1" == "start" && "$2" == "all" ]]; then
  start_all; exit 0
elif [[ "$1" == "stop" && "$2" == "all" ]]; then
  stop_all; exit 0
elif [[ "$1" == "restart" && "$2" == "all" ]]; then
  restart_all; exit 0
elif [[ "$1" == "start" && -n "$2" ]]; then
  svc=$(add_service_suffix "$2")
  if service_exists "$svc"; then
    if is_active "$svc"; then
      echo "üîÑ Servi√ßo $svc j√° est√° rodando."
    else
      systemctl start "$svc"
      echo "‚úÖ Servi√ßo $svc iniciado com sucesso."
      
    fi
  else
    echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado."
  fi
  exit 0
elif [[ "$1" == "stop" && -n "$2" ]]; then
  svc=$(add_service_suffix "$2")
  if service_exists "$svc"; then
    if is_active "$svc"; then
      systemctl stop "$svc"
      echo "‚úÖ Servi√ßo $svc parado com sucesso."
    else
      echo "‚è∏Ô∏è Servi√ßo $svc j√° est√° parado."
    fi
  else
    echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado."
  fi
  exit 0
elif [[ "$1" == "restart" && -n "$2" ]]; then
  svc=$(add_service_suffix "$2")
  if service_exists "$svc"; then
    systemctl restart "$svc"
    echo "‚úÖ Servi√ßo $svc reiniciado com sucesso."
  else
    echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado."
  fi
  exit 0
elif [[ "$1" == "status" && -n "$2" ]]; then
  svc=$(add_service_suffix "$2")
  if service_exists "$svc"; then
    systemctl status "$svc"
  else
    echo "‚ö†Ô∏è  Servi√ßo $svc n√£o encontrado."
  fi
  exit 0
fi

# Menu interativo
while true; do
  echo ""
  echo "Escolha uma op√ß√£o:"
  echo "1) Iniciar todos os servi√ßos"
  echo "2) Parar todos os servi√ßos"
  echo "3) Reiniciar todos os servi√ßos"
  echo "4) Iniciar servi√ßo individual"
  echo "5) Parar servi√ßo individual"
  echo "6) Reiniciar servi√ßo individual"
  echo "7) Ver status de servi√ßo individual"
  echo "0) Sair"
  read -rp "Op√ß√£o: " opcao

  case $opcao in
    1) start_all ;;
    2) stop_all ;;
    3) restart_all ;;
    4) start_service ;;
    5) stop_service ;;
    6) restart_service ;;
    7) status_service ;;
    0) echo "Saindo..."; exit 0 ;;
    *) echo "‚ùå Op√ß√£o inv√°lida, tente novamente." ;;
  esac
done
