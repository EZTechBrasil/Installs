#!/bin/bash
# ====================================================================
# Menu Interativo de Edição de INI EZLX - Centralizado
# ====================================================================
# Cores para output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly MAGENTA='\033[0;35m'
readonly WHITE='\033[1;37m'
readonly NC='\033[0m'
readonly BOLD='\033[1m'

CONFIG_DIR="/usr/ezlx/etc"

# ====================================================================
# FUNÇÕES DE CENTRALIZAÇÃO
# ====================================================================
get_terminal_width() {
    tput cols
}

get_terminal_height() {
    tput lines
}

center_text() {
    local text="$1"
    local width=$(get_terminal_width)
    # Remove códigos de cor para calcular o comprimento real
    local clean_text=$(echo -e "$text" | sed -E 's/\x1b\[[0-9;]*m//g')
    local text_length=${#clean_text}
    local padding=$(( (width - text_length) / 2 ))
    [[ $padding -lt 0 ]] && padding=0
    printf "%${padding}s%b\n" "" "$text"
}

# Linha decorativa que ocupa toda a largura da tela
print_full_line() {
    local width=$(get_terminal_width)
    printf "${CYAN}%${width}s${NC}\n" | tr ' ' '━'
}

# Move o cursor para a parte inferior da tela
move_to_bottom() {
    local height=$(get_terminal_height)
    tput cup $((height - 2)) 0
}

# ====================================================================
# FUNÇÕES
# ====================================================================
print_info()    { center_text "${BLUE}[INFO]${NC} $1"; }
print_success() { center_text "${GREEN}[✓]${NC} $1"; }
print_warning() { center_text "${YELLOW}[WARNING]${NC} $1"; }
print_error()   { center_text "${RED}[✗]${NC} $1"; }
pause()         { 
    local width=$(get_terminal_width)
    local text="Pressione Enter para continuar..."
    local text_length=${#text}
    local padding=$(( (width - text_length) / 2 ))
    printf "%${padding}s" ""
    read -rp "$text"
}

# Banner com logo EZTech
print_banner() {
    clear
    echo ""
    center_text "${RED}${BOLD}  ███████╗███████╗${NC}${WHITE}${BOLD}████████╗███████╗ ██████╗██╗  ██╗${NC}"
    center_text "${RED}${BOLD}  ██╔════╝╚══███╔╝${NC}${WHITE}${BOLD}╚══██╔══╝██╔════╝██╔════╝██║  ██║${NC}"
    center_text "${RED}${BOLD}  █████╗    ███╔╝ ${NC}${WHITE}${BOLD}   ██║   █████╗  ██║     ███████║${NC}"
    center_text "${RED}${BOLD}  ██╔══╝   ███╔╝  ${NC}${WHITE}${BOLD}   ██║   ██╔══╝  ██║     ██╔══██║${NC}"
    center_text "${RED}${BOLD}  ███████╗███████╗${NC}${WHITE}${BOLD}   ██║   ███████╗╚██████╗██║  ██║${NC}"
    center_text "${RED}${BOLD}  ╚══════╝╚══════╝${NC}${WHITE}${BOLD}   ╚═╝   ╚══════╝ ╚═════╝╚═╝  ╚═╝${NC}"
    echo ""
    print_full_line
}

# Header do menu
print_menu_header() {
    print_banner
    center_text "${BOLD}${WHITE}Editor de Configurações INI - EZLX${NC}"
    print_full_line
    echo ""
}

# Exibe ajuda detalhada à esquerda
show_help() {
    clear
    echo -e "${RED}${BOLD}EZLX INI Editor v1.0${NC}"
    echo "============================================================"
    
    echo -e "${CYAN}Uso:${NC}"
    echo "  $0 [opção]          - Executa o editor de INI"
    echo "  ezini [opção]       - Alternativa de execução"
    echo ""
    
    echo -e "${CYAN}Opções:${NC}"
    echo "  -h, --help          Exibe esta ajuda detalhada"
    echo ""
    
    echo -e "${CYAN}Descrição:${NC}"
    echo "  Este script permite editar arquivos INI localizados em:"
    echo -e "  ${YELLOW}$CONFIG_DIR${NC}"
    echo "  de forma interativa usando o editor nano."
    echo ""
    
    echo -e "${CYAN}Funcionalidades Principais:${NC}"
    echo "  • Listar todos os arquivos INI do diretório de configuração"
    echo "  • Abrir o arquivo selecionado no editor nano"
    echo "  • Fornecer dicas de edição no nano (Ctrl+O para salvar, Ctrl+X para sair)"
    echo "  • Reiniciar automaticamente todos os serviços EZNet após a edição"
    echo ""
    
    echo -e "${CYAN}Dicas de edição no nano:${NC}"
    echo -e "  ${GREEN}→ Ctrl+O${NC} : Salvar alterações"
    echo -e "  ${GREEN}→ Ctrl+X${NC} : Sair do editor"
    echo -e "  ${GREEN}→ Ctrl+K${NC} : Cortar linha"
    echo -e "  ${GREEN}→ Ctrl+U${NC} : Colar linha"
    echo ""
    
    echo -e "${CYAN}Informações adicionais:${NC}"
    echo "  • Todos os arquivos editados serão aplicados após reinício dos serviços"
    echo "  • Caso não queira reiniciar os serviços automaticamente, saia do script antes de editar"
    echo "  • O script requer permissões sudo para editar arquivos e reiniciar serviços"
    echo ""
    
    echo "============================================================"
    echo ""
    echo -e "Pressione Enter para continuar..."
    read -r
}


# Lista arquivos INI
listar_inis() {
    mapfile -t INIS < <(ls "$CONFIG_DIR"/*.ini 2>/dev/null)
    if [[ ${#INIS[@]} -eq 0 ]]; then
        print_error "Nenhum arquivo INI encontrado para edição."
        exit 1
    fi
    
    local i=1
    for ini in "${INIS[@]}"; do
        echo -e "  ${CYAN}[$i]${NC} ${WHITE}$(basename "$ini")${NC}"
        ((i++))
    done
    echo ""
    echo -e "  ${CYAN}[0]${NC} ${RED}Sair${NC}"
}

# Abre arquivo no nano com instruções
editar_ini() {
    local arquivo="$1"
    echo ""
    print_full_line
    print_info "Abrindo ${YELLOW}$(basename "$arquivo")${NC} no nano..."
    echo ""
    center_text "${GREEN}Dicas:${NC}"
    center_text "• Ctrl+O para salvar"
    center_text "• Ctrl+X para sair"
    echo ""
    print_full_line
    sleep 2
    
    sudo nano "$arquivo"
    
    clear
    print_banner
    print_success "Edição de ${YELLOW}$(basename "$arquivo")${NC} finalizada!"
    
    # Reinicia o EZNet
    echo ""
    print_full_line
    print_info "Reiniciando todos os serviços EZNet..."
    echo ""
    
    sudo eznet restart all
    
    echo ""
    print_success "Todos os serviços EZLX foram reiniciados!"
    print_full_line
    echo ""
    pause
}

# ====================================================================
# MENU INTERATIVO
# ====================================================================
menu_principal() {
    while true; do
        print_menu_header
        listar_inis
        echo ""
        
        # Move o cursor para o final da tela e desenha a linha
        move_to_bottom
        print_full_line
        echo -e "${WHITE}Escolha uma opção:${NC} \c"
        read -r opcao
        
        if [[ "$opcao" == "0" ]]; then
            clear
            print_full_line
            print_info "Encerrando EZTech INI Editor..."
            print_full_line
            echo ""
            exit 0
        elif [[ "$opcao" =~ ^[0-9]+$ ]] && [[ "$opcao" -le "${#INIS[@]}" ]] && [[ "$opcao" -ge 1 ]]; then
            arquivo_selecionado="${INIS[$((opcao-1))]}"
            editar_ini "$arquivo_selecionado"
        else
            clear
            print_menu_header
            listar_inis
            echo ""
            print_error "Opção inválida! Escolha um número entre 0 e ${#INIS[@]}"
            echo ""
            pause
        fi
    done
}

# ====================================================================
# EXECUÇÃO
# ====================================================================
# Verifica se o usuário passou -h ou --help
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

menu_principal
